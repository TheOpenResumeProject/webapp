<!doctype html>
<html>

<head>
    <title>Generate Resume from Data</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-5">
                <h3>Editor</h3>
                <form>
                    <div class="form-group">
                        <textarea class="form-control" id="resumeDataInput" rows="10"
                             style="height:75vh; width:-webkit-fill-available; border:1px dotted black;border-radius:5px;
                            font-family: Courier New,Courier,Lucida Sans Typewriter,Lucida Typewriter,monospace;">{{ resume_json }}</textarea>
                    </div>
				    <div class="form-group m-2">
						<label for="resumeTemplatePicked" class="form-label">Pick a template</label>
						<select class="form-select" aria-label="Pick a Template" id="resumeTemplatePicked">
						  <option value="1">template 1</option>
						  <option value="2">template 2</option>
						</select>
					</div>
                    <div class="form-group m-2">
                        <button type="button" class="btn btn-primary" id="applyButton">Apply Changes</button>
                    </div>
                </form>
            </div>
            <div class="col-7">
                <h3>Generated Resume</h3>
                <iframe src="{{ url_for('template') }}" title="Generated Resume" id="renderBoxElem"
                 style="height:85vh; width:800px;border:1px dotted black;border-radius:5px;"></iframe>
                <div class="form-group m-2">
                    <button type="button" class="btn btn-secondary" id="generatePDFButton">Save to PDF</button>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    const applyBtnElem = document.getElementById("applyButton");

    function getRenderedResume(e){
      const textAreaElem = document.getElementById("resumeDataInput");
      const data = textAreaElem.value;
      const apiUrl = "{{ url_for('validate') }}";
      return fetch(apiUrl, {
      	method: "POST",
        body: data,
        headers: { "Content-Type": "application/json", },
      })
       .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
             const renderURL = "{{ url_for('render') }}";
             return fetch(renderURL, {
                method: "POST",
                body: JSON.stringify(data),
                headers: {"Content-Type": "application/json"}
            }).then(resp => {
                return resp.text();
            }).then(text => {
                    const renderBoxElem = document.getElementById("renderBoxElem");
                    const rendered = text;
                    filledOutResum = text;
                    renderBoxElem.srcdoc = rendered;

                    return text;
                }
             )
             .catch(err => { console.log("failed to render");})
        })
        .catch(error => {
          console.error('Error:', error);
        });

    }
    applyBtnElem.addEventListener("click", getRenderedResume);

    const generatePDFBtnElem = document.getElementById("generatePDFButton");
    generatePDFBtnElem.addEventListener("click", function(e) {
      const textAreaElem = document.getElementById("resumeDataInput");
      const data = textAreaElem.value;

      // Prepare the data in JSON format for the validation API
      const apiUrl = "{{ url_for('validate') }}";

      fetch(apiUrl, {
        method: "POST",
        body: JSON.stringify(data), // Ensure data is wrapped in an object
        headers: {
          "Content-Type": "application/json",
        },
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(validatedData => {
        const renderURL = "{{ url_for('render_pdf') }}";

        // Now send the validated data to the render PDF API
        return fetch(renderURL, {
          method: "POST",
          body: validatedData,
          headers: {
            "Content-Type": "application/json",
          },
        })
        .then(resp => resp.blob())
        .then(pdfBlob => {
            const pdfUrl = URL.createObjectURL(pdfBlob);

            const link = document.createElement('a');
            link.href = pdfUrl;
            link.download = "generated_resume.pdf";  // Filename for the download
            link.click();  // Trigger the download

            URL.revokeObjectURL(pdfUrl);
        })
        .catch(err => {
          console.error("Failed to render PDF:", err);
        });
      })
      .catch(error => {
        console.error('Error:', error);
      });
    });


</script>

</html>
